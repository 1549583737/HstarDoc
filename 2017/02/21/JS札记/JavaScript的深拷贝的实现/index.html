<!DOCTYPE html><html class="han-init" lang="zh-Hant"><head><meta name="author" content="Jay.M.Hu"><meta name="description" itemprop="description" content="JavaScript的数据类型简单数据类型
string
number
boolean
function
null
undefined

复杂数据类型
String
Number
Boolean
Function
Date
Array
RegExp 
Object 

各种类型的深复制方式：先来看看"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>JavaScript的深拷贝的实现 · Love life, love coding~</title><link rel="stylesheet" type="text/css" href="/blog/font/fantasque_sans_mono/stylesheet.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/webicons/2.0.0/webicons.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/Han/3.3.0/han.min.css"><link rel="stylesheet" type="text/css" href="/blog/styles/screen.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/highlight.js/9.9.0/styles/gruvbox-dark.min.css"></head><body><header><a href="/blog/"><img class="logo" src="https://avatars1.githubusercontent.com/u/4043284?v=3&amp;s=460" alt="幻☆精灵的Blog" title="幻☆精灵的Blog"></a><h1><a href="/blog/" alt="幻☆精灵的Blog" title="幻☆精灵的Blog">幻☆精灵的Blog</a></h1><p>Love life, love coding~</p><nav><ul><li><a href="/" alt="首页" title="首页">首页</a></li><li><a href="pigeonhole" alt="归档" title="归档">归档</a></li><li><a href="links" alt="链接" title="链接">链接</a></li><li><a href="about" alt="关于" title="关于">关于</a></li></ul><div class="xnews-icon"><a target="_blank" href="https://github.com/hstarorg" style="position: relative; top: -2px;">&#xe735;</a><a target="_blank" href="https://twitter.com/Hstar19">&#xe71f;</a><a target="_blank" href="https://www.facebook.com/100015363883648">&#xe60b;</a><a target="_blank" href="https://www.zhihu.com/people/hstar">&#xe63f;</a><a target="_blank" href="https://weibo.com/hstarorg" style="position: relative; top: -2px;">&#xe603;</a></div></nav><div class="space"></div></header><main><article class="full"><h1>JavaScript的深拷贝的实现</h1><span class="post-meta">写于<time> 2017 年 02 月 21 日 14 时 47 分</time><br>更新于<time> 2017 年 02 月 21 日 14 时 47 分</time></span><div class="article-toc"><strong>大纲</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#JavaScript的数据类型"><span class="toc-number">1.</span> <span class="toc-text">JavaScript的数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#简单数据类型"><span class="toc-number">1.1.</span> <span class="toc-text">简单数据类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#复杂数据类型"><span class="toc-number">1.2.</span> <span class="toc-text">复杂数据类型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#各种类型的深复制方式："><span class="toc-number">2.</span> <span class="toc-text">各种类型的深复制方式：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#最终的深复制代码"><span class="toc-number">3.</span> <span class="toc-text">最终的深复制代码</span></a></li></ol></div><h2 id="JavaScript的数据类型"><a href="#JavaScript的数据类型" class="headerlink" title="JavaScript的数据类型"></a>JavaScript的数据类型</h2><h3 id="简单数据类型"><a href="#简单数据类型" class="headerlink" title="简单数据类型"></a>简单数据类型</h3><ol>
<li>string</li>
<li>number</li>
<li>boolean</li>
<li>function</li>
<li>null</li>
<li>undefined</li>
</ol>
<h3 id="复杂数据类型"><a href="#复杂数据类型" class="headerlink" title="复杂数据类型"></a>复杂数据类型</h3><ol>
<li>String</li>
<li>Number</li>
<li>Boolean</li>
<li>Function</li>
<li>Date</li>
<li>Array</li>
<li>RegExp </li>
<li>Object </li>
</ol>
<h2 id="各种类型的深复制方式："><a href="#各种类型的深复制方式：" class="headerlink" title="各种类型的深复制方式："></a>各种类型的深复制方式：</h2><p>先来看看简单类型的复制方式：</p>
<pre><code>//string
var s1 = &apos;abc&apos;;
var s2 = s1;
s2 = &apos;ccc&apos;;
console.log(s1);

//number
var n1 = 12.1;
var n2 = n1;
n2 = 7410;
console.log(n1);

//boolean
var b1 = true;
var b2 = b1;
b2 = false;
console.log(b1);

//null
var nu1 = null;
var nu2 = nu1;
nu2 = &apos;abc&apos;;
console.log(nu1);

//undefined
var u1 = undefined;
var u2 = u1;
u2 = &apos;abc&apos;;
console.log(u1);
</code></pre><p>从以上的代码可以看出，简单类型，只需要直接赋值就是深复制了。但是也有一个例外，那就是function。</p>
<p>接着来看看String、Number、Boolean、Date的深复制：</p>
<pre><code>//String
var s1 = new String(&apos;s1&apos;);
var s2 = new String(s1);
console.log(s2);

//Number
var n1 = new Number(&apos;1&apos;);
var n2 = new Number(n1);
console.log(n2);

//Boolean
var b1 = new Boolean(1);
var b2 = new Boolean(b1);
console.log(b2);

//Date
var d1 = new Date();
var d2 = new Date(d1);
console.log(d2);
</code></pre><p>除以上的做法之外，还需要对实例属性进行拷贝。那么剩下的Function、function、RegExp和Array还有Object又该怎么拷贝呢？这几个比较特殊，我们一个一个来：</p>
<p>对于Function和function的深拷贝，我们可以按照如下的方式来做：</p>
<pre><code>var f1 = new Function(&apos;a&apos;, &apos;console.log(&quot;f1&quot; + a);&apos;);
var f2 = function(b){console.log(&apos;f2&apos; + b);};

//通过toString获取源代码(有浏览器兼容问题)
var code = f1.toString();
//利用eval进行复制
var f1_copy = (function(functionCode){
  eval(&apos;var f = &apos; + functionCode);
  return f;
})(code);

f1_copy(&apos;abc&apos;);

//当然f2也可以用同样的方式来复制。
</code></pre><p>接着，我们来看下RegExp，可以同样同时eval来执行拷贝，也可以使用如下方式：</p>
<pre><code>var reg1 = /abc/g;
var reg2 = new RegExp(&apos;abc&apos;, &apos;gmi&apos;);

var reg1_copy = (function(reg){
  var pattern = reg.valueOf();
  var flags = (pattern.global ? &apos;g&apos; : &apos;&apos;) + 
    (pattern.ignorecase ? &apos;i&apos; : &apos;&apos;) + (pattern.multiline ? &apos;m&apos; : &apos;&apos;);
  return new RegExp(pattern.source, flags);
})(reg1);
</code></pre><p>最后，我们来说一说Array的复制，有的人可以说，直接用slice复制一份出来就是了，那我们来看看，是否真的达到效果的呢？</p>
<pre><code>var o = {name: &apos;Jay&apos;};
var arr1 = [o, &apos;22&apos;, 1];
var arr2 = arr1.slice(0);
arr2[0].name = &apos;Arr2&apos;;
console.log(arr1[0].name);
</code></pre><p>很简短的代码，直接就把slice抛弃了，slice只能保证Array是新的，并不意味着内部的元素是深拷贝的，那么如何做呢？就是遍历元素，对每个元素进行深拷贝了。代码如下：</p>
<pre><code>var o = {name: &apos;Jay&apos;};
var arr1 = [o, &apos;22&apos;, 1];

var arr2 = [];
for(var i = 0, len = arr1.length; i &lt; len; i++){
  //注意，deepClone还未实现
  arr2.push(deepClone(arr1[i]));
}
</code></pre><p>以上对针对不同的类型，特殊的代码，那么如何来拷贝实例属性呢？代码如下：</p>
<pre><code>var o = {p1: &apos;1&apos;, p2: 2, p3: function(){}};

var copy = {};
for(var p in o){
  //注意deepClone还未实现
  copy[p] = deepClone(o[p]);
}
</code></pre><p><strong>注意：针对复杂类型，还需要同时copy.constructor = source.constructor来保证构造函数一致。</strong></p>
<h2 id="最终的深复制代码"><a href="#最终的深复制代码" class="headerlink" title="最终的深复制代码"></a>最终的深复制代码</h2><p>通过以上的分析与代码示例，那么我们最终的代码又是怎样的呢？详细代码如下：</p>
<pre><code>//自调用函数，防御性编程
;
(function (window) {
  &apos;use strict&apos;;

  function getCustomType(obj) {
    var type = typeof obj,
      resultType = &apos;object&apos;;
    //简单类型
    if (type !== &apos;object&apos; || obj === null) {
      resultType = &apos;simple&apos;;
    } else if (obj instanceof String || obj instanceof Number || obj instanceof Boolean || obj instanceof Date) {
      resultType = &apos;complex&apos;;
    } else if (obj instanceof Function) {
      resultType = &apos;function&apos;;
    } else if (obj instanceof RegExp) {
      resultType = &apos;regexp&apos;;
    } else if (obj instanceof Array) {
      resultType = &apos;array&apos;;
    }
    return resultType;
  }

  function cloneProperties(dest, source) {
    dest.constructor = source.constructor;
    for (var p in source) {
      dest[p] = deepClone(source[p]);
    }
    return dest;
  }

  function cloneSimple(obj) {
    return obj;
  }

  function cloneComplex(obj) {
    var result = new obj.constructor(obj);
    return cloneProperties(result);
  }

  function cloneFunction(obj) {
    var funCopy = (function (f) {
      eval(&apos;var abcdefg_$$$$ = &apos; + obj.toString());
      return abcdefg_$$$$;
    })(obj);
    return cloneProperties(funCopy);
  }

  function cloneRegExp(obj) {
    var pattern = obj.valueOf();
    var flags = (pattern.global ? &apos;g&apos; : &apos;&apos;) +
      (pattern.ignorecase ? &apos;i&apos; : &apos;&apos;) + (pattern.multiline ? &apos;m&apos; : &apos;&apos;);
    var reg = new RegExp(pattern.source, flags);
    return cloneProperties(reg);
  }

  function cloneArray(obj) {
    var resultArr = [];
    for (var i = 0, len = obj.length; i &lt; len; i++) {
      resultArr.push(deepClone(obj[i]));
    }
    for (var p in obj) {
      if (typeof p === &apos;number&apos; &amp;&amp; p &lt; len) {
        continue;
      }
      resultArr[p] = deepClone(obj[p]);
    }
    return resultArr;
  }

  function cloneObject(obj) {
    var result = {};
    result.constructor = obj.constructor;
    for (var p in obj) {
      result[p] = deepClone(obj[p]);
    }
    return result;
  }

  function deepClone(obj) {
    var f = undefined;
    switch (getCustomType(obj)) {
    case &apos;simple&apos;:
      f = cloneSimple;
      break;
    case &apos;complex&apos;:
      f = cloneComplex;
      break;
    case &apos;function&apos;:
      f = cloneFunction;
      break;
    case &apos;regexp&apos;:
      f = cloneRegExp;
      break;
    case &apos;array&apos;:
      f = cloneArray;
      break;
    case &apos;object&apos;:
      f = cloneObject;
      break;
    }
    return f.call(undefined, obj);
  }

  //挂载到window对象上
  window.deepClone = deepClone;
})(window);
</code></pre><hr><section class="comment"><div class="ds-thread" data-thread-key="/blog/2017/02/21/JS札记/JavaScript的深拷贝的实现/" data-title="JavaScript的深拷贝的实现" data-url="http://hstarorg.github.io/blog/blog/2017/02/21/JS札记/JavaScript的深拷贝的实现/"></div></section><script>var _shortName = "6389370154370729000";</script><script>var duoshuoQuery = {};
duoshuoQuery["short_name"] = _shortName;
(function() {
    var ds = document.createElement("script");
    ds.type = "text/javascript";
    ds.async = true;
    ds.src = (document.location.protocol === "https:" ? "https:" : "http:") + "//static.duoshuo.com/embed.js";
    ds.charset = "utf-8";
    (document.getElementsByTagName("head")[0] ||
        document.getElementsByTagName("body")[0]).appendChild(ds);
})();</script><footer><section class="copyright">&copy; 2016 - 2017<a href="/blog/">Jay.M.Hu</a></section><section class="intro">由<a href="https://hexo.io/">Hexo</a>驱动&middot;挂载<a href="https://github.com/xadillax/hexo-xnew">X'new</a>主题</section></footer></article></main><script src="//cdn.bootcss.com/Han/3.3.0/han.min.js"></script><script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><script src="//cdn.bootcss.com/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script><script src="/blog/scripts/highlight.pack.js"></script><script>$(function() {
    $("header").backstretch("/images/header.jpeg");

    $("figure.highlight").each(function(i, block) {
        $(block).removeClass("highlight");
        $("<pre><code class='__tobehl " + ($(block).attr("class") === "plain" ? "" : ("lang-" + $(block).attr("class"))) + "'></code></pre>").insertAfter($(block));
        $(block).next().find("code").text((block.innerText || block.textContent));
        $(block).remove();
    });
    $(".__tobehl").each(function(i, block) {
        hljs.highlightBlock(block);
    });

    $("article.full img").each(function() {
        $(this).parent().css("text-align", "center");
    });

    if($(".article-toc").children().length < 2) {
        $(".article-toc").css("display", "none");
    }
});</script></body></html>