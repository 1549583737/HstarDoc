<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>JavaScript的深拷贝的实现 | 幻☆精灵的Blog</title>
  <meta name="description" content="幻☆精灵的Blog站点" />
  <meta name="keywords" content="幻精灵" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/blog/images/favicon.ico">
  <link rel="alternate" href="/blog/atom.xml" title="幻☆精灵的Blog">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="JavaScript的数据类型简单数据类型
string
number
boolean
function
null
undefined

复杂数据类型
String
Number
Boolean
Function
Date
Array
RegExp 
Object 

各种类型的深复制方式：先来看看简单类型的复制方式：
//string
var s1 = &amp;apos;abc&amp;apos;;
var">
<meta property="og:type" content="article">
<meta property="og:title" content="JavaScript的深拷贝的实现">
<meta property="og:url" content="http://hstarorg.github.io/blog/2017/02/21/JS札记/JavaScript的深拷贝的实现/index.html">
<meta property="og:site_name" content="幻☆精灵的Blog">
<meta property="og:description" content="JavaScript的数据类型简单数据类型
string
number
boolean
function
null
undefined

复杂数据类型
String
Number
Boolean
Function
Date
Array
RegExp 
Object 

各种类型的深复制方式：先来看看简单类型的复制方式：
//string
var s1 = &amp;apos;abc&amp;apos;;
var">
<meta property="og:updated_time" content="2017-02-21T07:07:32.332Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JavaScript的深拷贝的实现">
<meta name="twitter:description" content="JavaScript的数据类型简单数据类型
string
number
boolean
function
null
undefined

复杂数据类型
String
Number
Boolean
Function
Date
Array
RegExp 
Object 

各种类型的深复制方式：先来看看简单类型的复制方式：
//string
var s1 = &amp;apos;abc&amp;apos;;
var">
    
  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href='//cdn.bootcss.com/node-waves/0.7.5/waves.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="/blog/style.css">
  
  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>

<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
		<div class="wrapper container">
			<a class="logo flat-box" href='/blog/' >
				幻☆精灵的Blog
			</a>
			<div class='menu'>
				<ul class='h-list'>
					
						<li>
							<a class='flat-box nav-home' href='/blog/'>
								首页
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-archives' href='/blog/archives'>
								归档
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-about' href='/blog/about'>
								关于我
							</a>
						</li>
					
				</ul>
				<div class='underline'></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search"></span></a></li>
				
				<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu"></span></a></li>
			</ul>
		</div>
		<aside class="menu-phone">
			<nav>
				
					<a href="/blog/" class="nav-home nav">
						首页
					</a>
				
					<a href="/blog/archives" class="nav-archives nav">
						归档
					</a>
				
					<a href="/blog/about" class="nav-about nav">
						关于我
					</a>
				
			</nav>
		</aside>
</header>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container'>
      <div class='l_main'>
        <article id="post-JS札记/JavaScript的深拷贝的实现"
  class="post white-box article-type-post"
  itemscope itemprop="blogPost">
	<section class='meta'>
	<h2 class="title">
  	<a href="/blog/2017/02/21/JS札记/JavaScript的深拷贝的实现/">
    	JavaScript的深拷贝的实现
    </a>
  </h2>
	<time>
	  Feb 21, 2017
	</time>
	
	</section>
	
		<section class="tog"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#JavaScript的数据类型"><span class="toc-number">1.</span> <span class="toc-text">JavaScript的数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#简单数据类型"><span class="toc-number">1.1.</span> <span class="toc-text">简单数据类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#复杂数据类型"><span class="toc-number">1.2.</span> <span class="toc-text">复杂数据类型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#各种类型的深复制方式："><span class="toc-number">2.</span> <span class="toc-text">各种类型的深复制方式：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#最终的深复制代码"><span class="toc-number">3.</span> <span class="toc-text">最终的深复制代码</span></a></li></ol></section>
	
	<section class="article typo">
  	<div class="article-entry" itemprop="articleBody">
    	<h2 id="JavaScript的数据类型"><a href="#JavaScript的数据类型" class="headerlink" title="JavaScript的数据类型"></a>JavaScript的数据类型</h2><h3 id="简单数据类型"><a href="#简单数据类型" class="headerlink" title="简单数据类型"></a>简单数据类型</h3><ol>
<li>string</li>
<li>number</li>
<li>boolean</li>
<li>function</li>
<li>null</li>
<li>undefined</li>
</ol>
<h3 id="复杂数据类型"><a href="#复杂数据类型" class="headerlink" title="复杂数据类型"></a>复杂数据类型</h3><ol>
<li>String</li>
<li>Number</li>
<li>Boolean</li>
<li>Function</li>
<li>Date</li>
<li>Array</li>
<li>RegExp </li>
<li>Object </li>
</ol>
<h2 id="各种类型的深复制方式："><a href="#各种类型的深复制方式：" class="headerlink" title="各种类型的深复制方式："></a>各种类型的深复制方式：</h2><p>先来看看简单类型的复制方式：</p>
<pre><code>//string
var s1 = &apos;abc&apos;;
var s2 = s1;
s2 = &apos;ccc&apos;;
console.log(s1);

//number
var n1 = 12.1;
var n2 = n1;
n2 = 7410;
console.log(n1);

//boolean
var b1 = true;
var b2 = b1;
b2 = false;
console.log(b1);

//null
var nu1 = null;
var nu2 = nu1;
nu2 = &apos;abc&apos;;
console.log(nu1);

//undefined
var u1 = undefined;
var u2 = u1;
u2 = &apos;abc&apos;;
console.log(u1);
</code></pre><p>从以上的代码可以看出，简单类型，只需要直接赋值就是深复制了。但是也有一个例外，那就是function。</p>
<p>接着来看看String、Number、Boolean、Date的深复制：</p>
<pre><code>//String
var s1 = new String(&apos;s1&apos;);
var s2 = new String(s1);
console.log(s2);

//Number
var n1 = new Number(&apos;1&apos;);
var n2 = new Number(n1);
console.log(n2);

//Boolean
var b1 = new Boolean(1);
var b2 = new Boolean(b1);
console.log(b2);

//Date
var d1 = new Date();
var d2 = new Date(d1);
console.log(d2);
</code></pre><p>除以上的做法之外，还需要对实例属性进行拷贝。那么剩下的Function、function、RegExp和Array还有Object又该怎么拷贝呢？这几个比较特殊，我们一个一个来：</p>
<p>对于Function和function的深拷贝，我们可以按照如下的方式来做：</p>
<pre><code>var f1 = new Function(&apos;a&apos;, &apos;console.log(&quot;f1&quot; + a);&apos;);
var f2 = function(b){console.log(&apos;f2&apos; + b);};

//通过toString获取源代码(有浏览器兼容问题)
var code = f1.toString();
//利用eval进行复制
var f1_copy = (function(functionCode){
  eval(&apos;var f = &apos; + functionCode);
  return f;
})(code);

f1_copy(&apos;abc&apos;);

//当然f2也可以用同样的方式来复制。
</code></pre><p>接着，我们来看下RegExp，可以同样同时eval来执行拷贝，也可以使用如下方式：</p>
<pre><code>var reg1 = /abc/g;
var reg2 = new RegExp(&apos;abc&apos;, &apos;gmi&apos;);

var reg1_copy = (function(reg){
  var pattern = reg.valueOf();
  var flags = (pattern.global ? &apos;g&apos; : &apos;&apos;) + 
    (pattern.ignorecase ? &apos;i&apos; : &apos;&apos;) + (pattern.multiline ? &apos;m&apos; : &apos;&apos;);
  return new RegExp(pattern.source, flags);
})(reg1);
</code></pre><p>最后，我们来说一说Array的复制，有的人可以说，直接用slice复制一份出来就是了，那我们来看看，是否真的达到效果的呢？</p>
<pre><code>var o = {name: &apos;Jay&apos;};
var arr1 = [o, &apos;22&apos;, 1];
var arr2 = arr1.slice(0);
arr2[0].name = &apos;Arr2&apos;;
console.log(arr1[0].name);
</code></pre><p>很简短的代码，直接就把slice抛弃了，slice只能保证Array是新的，并不意味着内部的元素是深拷贝的，那么如何做呢？就是遍历元素，对每个元素进行深拷贝了。代码如下：</p>
<pre><code>var o = {name: &apos;Jay&apos;};
var arr1 = [o, &apos;22&apos;, 1];

var arr2 = [];
for(var i = 0, len = arr1.length; i &lt; len; i++){
  //注意，deepClone还未实现
  arr2.push(deepClone(arr1[i]));
}
</code></pre><p>以上对针对不同的类型，特殊的代码，那么如何来拷贝实例属性呢？代码如下：</p>
<pre><code>var o = {p1: &apos;1&apos;, p2: 2, p3: function(){}};

var copy = {};
for(var p in o){
  //注意deepClone还未实现
  copy[p] = deepClone(o[p]);
}
</code></pre><p><strong>注意：针对复杂类型，还需要同时copy.constructor = source.constructor来保证构造函数一致。</strong></p>
<h2 id="最终的深复制代码"><a href="#最终的深复制代码" class="headerlink" title="最终的深复制代码"></a>最终的深复制代码</h2><p>通过以上的分析与代码示例，那么我们最终的代码又是怎样的呢？详细代码如下：</p>
<pre><code>//自调用函数，防御性编程
;
(function (window) {
  &apos;use strict&apos;;

  function getCustomType(obj) {
    var type = typeof obj,
      resultType = &apos;object&apos;;
    //简单类型
    if (type !== &apos;object&apos; || obj === null) {
      resultType = &apos;simple&apos;;
    } else if (obj instanceof String || obj instanceof Number || obj instanceof Boolean || obj instanceof Date) {
      resultType = &apos;complex&apos;;
    } else if (obj instanceof Function) {
      resultType = &apos;function&apos;;
    } else if (obj instanceof RegExp) {
      resultType = &apos;regexp&apos;;
    } else if (obj instanceof Array) {
      resultType = &apos;array&apos;;
    }
    return resultType;
  }

  function cloneProperties(dest, source) {
    dest.constructor = source.constructor;
    for (var p in source) {
      dest[p] = deepClone(source[p]);
    }
    return dest;
  }

  function cloneSimple(obj) {
    return obj;
  }

  function cloneComplex(obj) {
    var result = new obj.constructor(obj);
    return cloneProperties(result);
  }

  function cloneFunction(obj) {
    var funCopy = (function (f) {
      eval(&apos;var abcdefg_$$$$ = &apos; + obj.toString());
      return abcdefg_$$$$;
    })(obj);
    return cloneProperties(funCopy);
  }

  function cloneRegExp(obj) {
    var pattern = obj.valueOf();
    var flags = (pattern.global ? &apos;g&apos; : &apos;&apos;) +
      (pattern.ignorecase ? &apos;i&apos; : &apos;&apos;) + (pattern.multiline ? &apos;m&apos; : &apos;&apos;);
    var reg = new RegExp(pattern.source, flags);
    return cloneProperties(reg);
  }

  function cloneArray(obj) {
    var resultArr = [];
    for (var i = 0, len = obj.length; i &lt; len; i++) {
      resultArr.push(deepClone(obj[i]));
    }
    for (var p in obj) {
      if (typeof p === &apos;number&apos; &amp;&amp; p &lt; len) {
        continue;
      }
      resultArr[p] = deepClone(obj[p]);
    }
    return resultArr;
  }

  function cloneObject(obj) {
    var result = {};
    result.constructor = obj.constructor;
    for (var p in obj) {
      result[p] = deepClone(obj[p]);
    }
    return result;
  }

  function deepClone(obj) {
    var f = undefined;
    switch (getCustomType(obj)) {
    case &apos;simple&apos;:
      f = cloneSimple;
      break;
    case &apos;complex&apos;:
      f = cloneComplex;
      break;
    case &apos;function&apos;:
      f = cloneFunction;
      break;
    case &apos;regexp&apos;:
      f = cloneRegExp;
      break;
    case &apos;array&apos;:
      f = cloneArray;
      break;
    case &apos;object&apos;:
      f = cloneObject;
      break;
    }
    return f.call(undefined, obj);
  }

  //挂载到window对象上
  window.deepClone = deepClone;
})(window);
</code></pre>
  	</div>
	  
	</section>
	
</article>

      </div>
      <aside class='l_side'>
        
  <section class='m_widget about'>

<img class='avatar waves-image' src='https://avatars1.githubusercontent.com/u/4043284?v=3&amp;s=460' />

<div class='header'>Jay.M.Hu</div>
<div class='content'>
<div></div>
</div>
</section>

  <section class='m_widget friendly-links'>
<div class='header'>Links</div>
<div class='content'>
    <ul class="entry">
    
        <li><a class="flat-box" target="_blank" href="http://humin.cnblogs.com/">
            <div class='name'>幻天芒 - 博客园</div>
        </a></li>
    
    </ul>
</div>
</section>

  <section class='m_widget categories'>
<div class='header'>Categories</div>
<div class='content'>
    
</div>
</section>

  


      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/hstarorg" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
    
  </div>
  
  <div>Theme <a href='https://github.com/stkevintan/hexo-theme-material-flow' class="codename">MaterialFlow</a> designed by <a href="http://keyin.me/" target="_blank">Kevin Tan</a>.</div>
  
</footer>


  <script>setLoadingBarProgress(80);</script>
  

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src='//cdn.bootcss.com/node-waves/0.7.5/waves.min.js'></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<script src="/blog/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/blog/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>
<script src="/blog/js/search.js"></script>
<script src="/blog/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
